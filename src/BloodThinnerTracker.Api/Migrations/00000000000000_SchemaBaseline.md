# Schema Baseline: Pre-Dosage Pattern Feature

**Date**: 2025-11-04  
**Feature**: 005-medicine-schedule-to (Complex Medication Dosage Patterns)  
**Purpose**: Document current database schema before implementing dosage pattern feature

## Current Schema State

### Core Entities

#### Users Table
- `Id` (int, PK)
- `PublicId` (uniqueidentifier)
- `Email` (nvarchar(255))
- `PasswordHash` (nvarchar(500))
- `FirstName` (nvarchar(100))
- `LastName` (nvarchar(100))
- `DateOfBirth` (datetime2)
- `Gender` (int enum)
- `PhoneNumber` (varchar(20))
- `EmergencyContact` (nvarchar(200))
- `EmergencyPhone` (varchar(20))
- `MedicalRecordNumber` (varchar(50))
- `HealthInsurance` (nvarchar(200))
- `PrimaryCareProvider` (nvarchar(200))
- `IsActive` (bit)
- `IsDeleted` (bit)
- `CreatedAt` (datetime2)
- `UpdatedAt` (datetime2)
- `DeletedAt` (datetime2, nullable)
- `CreatedBy` (nvarchar(100))
- `UpdatedBy` (nvarchar(100))

#### Medications Table
- `Id` (int, PK)
- `PublicId` (uniqueidentifier)
- `UserId` (int, FK to Users)
- `Name` (nvarchar(100))
- `GenericName` (nvarchar(100), nullable)
- `BrandName` (nvarchar(100), nullable)
- `Type` (int enum: Warfarin, Heparin, Other)
- `Dosage` (decimal(10,3))
- `DosageUnit` (varchar(20), default: "mg")
- `Form` (varchar(50), nullable)
- `Color` (varchar(50), nullable)
- `Shape` (varchar(50), nullable)
- `Imprint` (varchar(100), nullable)
- `IsBloodThinner` (bit, default: true)
- `Contraindications` (nvarchar(1000), nullable)
- `SideEffects` (nvarchar(1000), nullable)
- `Interactions` (nvarchar(1000), nullable)
- `Warnings` (nvarchar(1000), nullable)
- `Storage` (nvarchar(500), nullable)
- `Manufacturer` (nvarchar(200), nullable)
- `NDCCode` (varchar(50), nullable)
- `PrescriberName` (nvarchar(200), nullable)
- `PrescriberPhone` (varchar(20), nullable)
- `PharmacyName` (nvarchar(200), nullable)
- `PharmacyPhone` (varchar(20), nullable)
- `PrescriptionNumber` (varchar(100), nullable)
- `PrescriptionDate` (datetime2, nullable)
- `LastRefillDate` (datetime2, nullable)
- `NextRefillDate` (datetime2, nullable)
- `RefillsRemaining` (int, nullable)
- `IsActive` (bit)
- `IsDeleted` (bit)
- `CreatedAt` (datetime2)
- `UpdatedAt` (datetime2)
- `DeletedAt` (datetime2, nullable)
- `CreatedBy` (nvarchar(100))
- `UpdatedBy` (nvarchar(100))

**Current Limitation**: Single fixed dosage per medication (no pattern support)

#### MedicationLogs Table
- `Id` (int, PK)
- `PublicId` (uniqueidentifier)
- `UserId` (int, FK to Users)
- `MedicationId` (int, FK to Medications)
- `ScheduledTime` (datetime2)
- `ActualTime` (datetime2, nullable)
- `Status` (int enum: Scheduled, Taken, Skipped, Delayed)
- `ActualDosage` (decimal(10,3), nullable)
- `ActualDosageUnit` (varchar(20), nullable)
- `Reason` (nvarchar(500), nullable)
- `SideEffects` (nvarchar(500), nullable)
- `Notes` (nvarchar(1000), nullable)
- `EntryMethod` (int enum: Manual, Reminder, Scanned)
- `EntryDevice` (varchar(100), nullable)
- `Location` (varchar(100), nullable)
- `ConfirmedByProvider` (bit, default: false)
- `ConfirmedBy` (nvarchar(100), nullable)
- `ConfirmedAt` (datetime2, nullable)
- `TakenWithFood` (bit, nullable)
- `FoodDetails` (nvarchar(200), nullable)
- `TimeVarianceMinutes` (int)
- `IsActive` (bit)
- `IsDeleted` (bit)
- `CreatedAt` (datetime2)
- `UpdatedAt` (datetime2)
- `DeletedAt` (datetime2, nullable)
- `CreatedBy` (nvarchar(100))
- `UpdatedBy` (nvarchar(100))

**Current Limitation**: No variance tracking between expected and actual dosage

#### INRTests Table
- `Id` (int, PK)
- `PublicId` (uniqueidentifier)
- `UserId` (int, FK to Users)
- `TestDate` (datetime2)
- `INRValue` (decimal(4,2))
- `TestLocation` (nvarchar(200), nullable)
- `TestMethod` (nvarchar(100), nullable)
- `LabName` (nvarchar(200), nullable)
- `LabContactInfo` (nvarchar(200), nullable)
- `OrderedBy` (nvarchar(200), nullable)
- `ResultsReceivedDate` (datetime2, nullable)
- `InTargetRange` (bit)
- `TargetRangeLow` (decimal(4,2), nullable)
- `TargetRangeHigh` (decimal(4,2), nullable)
- `Notes` (nvarchar(1000), nullable)
- `FollowUpRequired` (bit)
- `FollowUpDate` (datetime2, nullable)
- `FollowUpNotes` (nvarchar(1000), nullable)
- `IsActive` (bit)
- `IsDeleted` (bit)
- `CreatedAt` (datetime2)
- `UpdatedAt` (datetime2)
- `DeletedAt` (datetime2, nullable)
- `CreatedBy` (nvarchar(100))
- `UpdatedBy` (nvarchar(100))

#### INRSchedules Table
- `Id` (int, PK)
- `PublicId` (uniqueidentifier)
- `UserId` (int, FK to Users)
- `NextTestDate` (datetime2)
- `FrequencyDays` (int)
- `Reminder` (bit)
- `ReminderDaysBefore` (int)
- `IsActive` (bit)
- `IsDeleted` (bit)
- `CreatedAt` (datetime2)
- `UpdatedAt` (datetime2)
- `DeletedAt` (datetime2, nullable)
- `CreatedBy` (nvarchar(100))
- `UpdatedBy` (nvarchar(100))

#### RefreshTokens Table
- `Id` (int, PK)
- `UserId` (int, FK to Users)
- `Token` (nvarchar(500))
- `ExpiresAt` (datetime2)
- `CreatedAt` (datetime2)
- `RevokedAt` (datetime2, nullable)
- `IsRevoked` (bit)

### Indexes

- `IX_Medications_UserId` on Medications(UserId)
- `IX_MedicationLogs_UserId` on MedicationLogs(UserId)
- `IX_MedicationLogs_MedicationId` on MedicationLogs(MedicationId)
- `IX_MedicationLogs_ScheduledTime` on MedicationLogs(ScheduledTime)
- `IX_INRTests_UserId` on INRTests(UserId)
- `IX_INRTests_TestDate` on INRTests(TestDate)
- `IX_INRSchedules_UserId` on INRSchedules(UserId)
- `IX_RefreshTokens_UserId` on RefreshTokens(UserId)

### Enums

#### MedicationType
- Warfarin = 0
- Heparin = 1
- Rivaroxaban = 2
- Apixaban = 3
- Dabigatran = 4
- Edoxaban = 5
- Enoxaparin = 6
- Fondaparinux = 7
- Other = 99

#### MedicationLogStatus
- Scheduled = 0
- Taken = 1
- Skipped = 2
- Delayed = 3
- Modified = 4

#### LogEntryMethod
- Manual = 0
- Reminder = 1
- Scanned = 2
- Imported = 3

#### Gender
- Unknown = 0
- Male = 1
- Female = 2
- Other = 3
- PreferNotToSay = 4

### Database Configuration

- **SQLite** (Development): JSON column support via TEXT columns
- **PostgreSQL** (Production): JSONB column support
- **Collation**: Case-insensitive for SQLite, default for PostgreSQL
- **Soft Delete**: All entities support IsDeleted flag
- **Audit Trail**: CreatedAt, UpdatedAt, DeletedAt, CreatedBy, UpdatedBy
- **Public IDs**: All entities have uniqueidentifier PublicId for external references

## Changes Required for Dosage Pattern Feature

### New Table: MedicationDosagePatterns
- Will store variable dosage patterns with temporal validity
- Will use JSON column for pattern sequence storage
- Will support pattern history tracking

### Medication Table Enhancements
- Add navigation property to DosagePatterns collection
- Add computed methods for pattern-based dosage calculation

### MedicationLog Table Enhancements
- Add ExpectedDosage (decimal)
- Add PatternDayNumber (int)
- Add PatternReference (nullable FK or string)
- Add HasVariance (computed property)

### New Indexes
- Temporal index on MedicationDosagePatterns (MedicationId, StartDate, EndDate)

## Migration Strategy

1. Create AddDosagePatterns migration (T008)
2. Apply migration to development database (T009)
3. Verify backward compatibility (existing medications work unchanged)
4. Test pattern feature with sample data
5. Document rollback procedure if needed

## Backward Compatibility

✅ All existing Medication records will continue to work with single fixed dosage  
✅ No breaking changes to existing API endpoints  
✅ Optional pattern feature - medications can exist without patterns  
✅ Soft delete preserves historical data  

## Notes

- This baseline was captured before any schema changes for the dosage pattern feature
- All timestamps use UTC
- Medical data is encrypted at rest (AES-256)
- Audit logging is enabled for all data modifications
- OWASP security guidelines are followed
