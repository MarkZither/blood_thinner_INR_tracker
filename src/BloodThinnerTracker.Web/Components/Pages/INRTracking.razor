@page "/inr"
@using BloodThinnerTracker.Shared.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@inject NavigationManager Navigation
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@rendermode InteractiveServer

<PageTitle>INR Tracking - Blood Thinner Tracker</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="inr-container">
    <!-- Medical Disclaimer -->
    <div class="alert alert-warning medical-disclaimer mb-4" role="alert">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <div>
                <strong>Critical Medical Information:</strong> INR (International Normalized Ratio) values are crucial for blood thinner management.
                Values outside your target range require immediate medical attention. Always consult your healthcare provider for INR interpretation and medication adjustments.
            </div>
        </div>
    </div>

    <!-- Header -->
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <MudStack Spacing="1">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.ShowChart" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.h4">INR Tracking</MudText>
            </MudStack>
            <MudText Typo="Typo.body2" Color="Color.Default">Monitor your blood clotting levels and trends</MudText>
        </MudStack>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Add"
                   OnClick="NavigateToAddINR">
            Add INR Result
        </MudButton>
    </MudStack>

    <!-- Current Status Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon @GetCurrentINRStatusClass() text-white mx-auto mb-2">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <h4 class="card-title mb-1">@(currentINR?.ToString("F1") ?? "N/A")</h4>
                    <p class="card-text text-muted small mb-0">Current INR</p>
                    @if (currentINRDate.HasValue)
                    {
                        <small class="text-muted">@currentINRDate.Value.ToString("MMM dd, yyyy")</small>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-info text-white mx-auto mb-2">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <h4 class="card-title mb-1">@targetRange</h4>
                    <p class="card-text text-muted small mb-0">Target Range</p>
                    <small class="text-muted">Set by physician</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-success text-white mx-auto mb-2">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <h4 class="card-title mb-1">@timeInRangePercentage%</h4>
                    <p class="card-text text-muted small mb-0">Time in Range</p>
                    <small class="text-muted">Last 3 months</small>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="stat-icon @GetNextTestStatusClass() text-white mx-auto mb-2">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <h4 class="card-title mb-1">@daysUntilNextTest</h4>
                    <p class="card-text text-muted small mb-0">Days Until Next Test</p>
                    @if (nextTestDate.HasValue)
                    {
                        <small class="text-muted">@nextTestDate.Value.ToString("MMM dd, yyyy")</small>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- INR Trend Chart -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <MudText Typo="Typo.h5">
                <MudIcon Icon="@Icons.Material.Filled.ShowChart" Class="mr-2" />
                INR Trend Analysis
            </MudText>
            <MudButtonGroup OverrideStyles="false">
                <MudButton Variant="@(chartPeriod == "3m" ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Primary" Size="Size.Small" OnClick="ChangeChartPeriod3M">3M</MudButton>
                <MudButton Variant="@(chartPeriod == "6m" ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Primary" Size="Size.Small" OnClick="ChangeChartPeriod6M">6M</MudButton>
                <MudButton Variant="@(chartPeriod == "1y" ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Primary" Size="Size.Small" OnClick="ChangeChartPeriod1Y">1Y</MudButton>
                <MudButton Variant="@(chartPeriod == "all" ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Primary" Size="Size.Small" OnClick="ChangeChartPeriodAll">All</MudButton>
            </MudButtonGroup>
        </div>

        @if (inrTests?.Any() == true)
        {
            <MudChart ChartType="ChartType.Line"
                      ChartSeries="@chartSeries"
                      XAxisLabels="@chartLabels"
                      Width="100%"
                      Height="400px"
                      ChartOptions="@chartOptions">
            </MudChart>

            <!-- Chart Legend -->
            <div class="mt-4">
                <MudGrid Justify="Justify.Center">
                    <MudItem xs="12" sm="6" md="3">
                        <div class="d-flex align-items-center">
                            <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Success" Size="Size.Small" Class="mr-2" />
                            <MudText Typo="Typo.body2">Target Range (@targetRange)</MudText>
                        </div>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <div class="d-flex align-items-center">
                            <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Primary" Size="Size.Small" Class="mr-2" />
                            <MudText Typo="Typo.body2">INR Values</MudText>
                        </div>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <div class="d-flex align-items-center">
                            <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Warning" Size="Size.Small" Class="mr-2" />
                            <MudText Typo="Typo.body2">Below Range (Risk of Clots)</MudText>
                        </div>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <div class="d-flex align-items-center">
                            <MudIcon Icon="@Icons.Material.Filled.Circle" Color="Color.Error" Size="Size.Small" Class="mr-2" />
                            <MudText Typo="Typo.body2">Above Range (Risk of Bleeding)</MudText>
                        </div>
                    </MudItem>
                </MudGrid>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <MudIcon Icon="@Icons.Material.Filled.ShowChart" Size="Size.Large" Color="Color.Default" Class="mb-3" />
                <MudText Typo="Typo.h6" Color="Color.Default">No INR Data Available</MudText>
                <MudText Typo="Typo.body1" Color="Color.Default" Class="mb-4">Start tracking your INR levels to see trends and analysis</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add" OnClick="NavigateToAddINR">
                    Add Your First INR Result
                </MudButton>
            </div>
        }
    </MudPaper>

    <!-- INR History Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-white border-bottom">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.History" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">INR Test History</MudText>
                </MudStack>
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Default"
                               StartIcon="@Icons.Material.Filled.Download"
                               Size="Size.Small"
                               OnClick="ExportINRData">
                        Export
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               Size="Size.Small"
                               OnClick="NavigateToAddINR">
                        Add Result
                    </MudButton>
                </MudStack>
            </MudStack>
        </div>
        <div class="card-body">
            @if (inrTests?.Any() == true)
            {
                <MudTable Items="@inrTests.OrderByDescending(t => t.TestDate)"
                          Hover="true"
                          Breakpoint="Breakpoint.Sm"
                          Dense="false"
                          Striped="false">
                    <HeaderContent>
                        <MudTh>Date</MudTh>
                        <MudTh>INR Value</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Laboratory</MudTh>
                        <MudTh>Notes</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="test">
                        <MudTd DataLabel="Date" Class="@GetRowClass(test.INRValue)">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2"><strong>@test.TestDate.ToString("MMM dd, yyyy")</strong></MudText>
                                <MudText Typo="Typo.caption" Color="Color.Default">@test.TestDate.ToString("HH:mm")</MudText>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="INR Value" Class="@GetRowClass(test.INRValue)">
                            <MudText Typo="Typo.body1" Class="@GetValueClass(test.INRValue)">
                                @test.INRValue.ToString("F1")
                            </MudText>
                        </MudTd>
                        <MudTd DataLabel="Status" Class="@GetRowClass(test.INRValue)">
                            <MudChip T="string"
                                     Color="@GetStatusChipColor(test.INRValue)"
                                     Size="Size.Small">
                                @GetStatusText(test.INRValue)
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Laboratory" Class="@GetRowClass(test.INRValue)">
                            <MudText Typo="Typo.body2">@(test.Laboratory ?? "Not specified")</MudText>
                        </MudTd>
                        <MudTd DataLabel="Notes" Class="@GetRowClass(test.INRValue)">
                            @if (!string.IsNullOrEmpty(test.Notes))
                            {
                                <MudText Typo="Typo.body2" title="@test.Notes">
                                    @(test.Notes.Length > 30 ? test.Notes.Substring(0, 30) + "..." : test.Notes)
                                </MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Default">No notes</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="Actions" Class="@GetRowClass(test.INRValue)">
                            <MudButtonGroup Size="Size.Small" OverrideStyles="false">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                              Color="Color.Primary"
                                              Size="Size.Small"
                                              OnClick="@(() => EditINRTest(test.Id.ToString()))"
                                              title="Edit" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                              Color="Color.Error"
                                              Size="Size.Small"
                                              OnClick="@(() => DeleteINRTest(test.Id.ToString()))"
                                              title="Delete" />
                            </MudButtonGroup>
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[]{10, 25, 50, 100}" />
                    </PagerContent>
                </MudTable>
            }
            else
            {
                <MudStack AlignItems="AlignItems.Center" Class="py-4" Spacing="3">
                    <MudIcon Icon="@Icons.Material.Filled.Biotech" Size="Size.Large" Color="Color.Default" />
                    <MudText Typo="Typo.h6" Color="Color.Default">No INR Tests Recorded</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Default" Align="Align.Center">
                        Start tracking your INR levels to monitor your blood thinner effectiveness
                    </MudText>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="NavigateToAddINR">
                        Record Your First INR Test
                    </MudButton>
                </MudStack>
            }
        </div>
    </div>
</div>
    </Authorized>
    <Authorizing>
        <div class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    </Authorizing>
    <NotAuthorized>
        @{
            var returnUrl = Uri.EscapeDataString(Navigation.Uri);
            Navigation.NavigateTo($"/login?returnUrl={returnUrl}", forceLoad: true);
        }
    </NotAuthorized>
</AuthorizeView>

@code {
    // Current status data
    private decimal? currentINR = 2.3m;
    private DateTime? currentINRDate = DateTime.Today.AddDays(-5);
    private string targetRange = "2.0-3.0";
    private int timeInRangePercentage = 78;
    private DateTime? nextTestDate = DateTime.Today.AddDays(10);
    private int daysUntilNextTest = 10;

    // Chart and filtering
    private string chartPeriod = "3m";

    // MudBlazor Chart data
    private List<ChartSeries> chartSeries = new();
    private string[] chartLabels = Array.Empty<string>();
    private ChartOptions chartOptions = new ChartOptions();

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    // Data
    private List<INRTest>? inrTests;

    protected override async Task OnInitializedAsync()
    {
        await LoadINRData();
        PrepareChartData();
    }

    private async Task LoadINRData()
    {
        try
        {
            // Call API to get INR tests
            var response = await Http.GetFromJsonAsync<List<INRTestResponse>>("api/v1/inr/tests?take=100");

            if (response != null && response.Any())
            {
                // Map response to INRTest entities
                inrTests = response.Select(r => new INRTest
                {
                    Id = int.TryParse(r.Id, out var id) ? id : 0,
                    UserId = int.TryParse(r.UserId, out var userId) ? userId : 0,
                    TestDate = r.TestDate,
                    INRValue = r.INRValue,
                    TargetINRMin = r.TargetINRMin,
                    TargetINRMax = r.TargetINRMax,
                    ProthrombinTime = r.ProthrombinTime,
                    PartialThromboplastinTime = r.PartialThromboplastinTime,
                    Laboratory = r.Laboratory,
                    OrderedBy = r.OrderedBy,
                    TestMethod = r.TestMethod,
                    IsPointOfCare = r.IsPointOfCare,
                    WasFasting = r.WasFasting,
                    LastMedicationTime = r.LastMedicationTime,
                    MedicationsTaken = r.MedicationsTaken,
                    FoodsConsumed = r.FoodsConsumed,
                    HealthConditions = r.HealthConditions,
                    Status = r.Status,
                    RecommendedActions = r.RecommendedActions,
                    DosageChanges = r.DosageChanges,
                    NextTestDate = r.NextTestDate,
                    Notes = r.Notes,
                    ReviewedByProvider = r.ReviewedByProvider,
                    ReviewedBy = r.ReviewedBy,
                    ReviewedAt = r.ReviewedAt,
                    PatientNotified = r.PatientNotified,
                    NotificationMethod = r.NotificationMethod,
                    CreatedAt = r.CreatedAt,
                    UpdatedAt = r.UpdatedAt ?? r.CreatedAt
                }).ToList();

                // Update current status from latest test
                var latestTest = inrTests.OrderByDescending(t => t.TestDate).FirstOrDefault();
                if (latestTest != null)
                {
                    currentINR = latestTest.INRValue;
                    currentINRDate = latestTest.TestDate;

                    if (latestTest.TargetINRMin.HasValue && latestTest.TargetINRMax.HasValue)
                    {
                        targetRange = $"{latestTest.TargetINRMin:F1}-{latestTest.TargetINRMax:F1}";
                    }

                    nextTestDate = latestTest.NextTestDate;
                    if (nextTestDate.HasValue)
                    {
                        daysUntilNextTest = (nextTestDate.Value - DateTime.Today).Days;
                    }
                }

                // Calculate time in range percentage (last 90 days)
                var threeMonthsAgo = DateTime.Today.AddDays(-90);
                var recentTests = inrTests.Where(t => t.TestDate >= threeMonthsAgo).ToList();
                if (recentTests.Any())
                {
                    var inRangeCount = recentTests.Count(t => t.Status == INRResultStatus.InRange);
                    timeInRangePercentage = (int)Math.Round((double)inRangeCount / recentTests.Count * 100);
                }
            }
            else
            {
                inrTests = new List<INRTest>();
            }

            // Calculate pagination
            var totalItems = inrTests?.Count ?? 0;
            totalPages = (int)Math.Ceiling((double)totalItems / pageSize);
        }
        catch (HttpRequestException ex)
        {
            Snackbar.Add($"Network error loading INR data: {ex.Message}", Severity.Error);
            inrTests = new List<INRTest>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading INR data: {ex.Message}", Severity.Error);
            inrTests = new List<INRTest>();
        }
    }

    private void PrepareChartData()
    {
        if (inrTests?.Any() != true)
        {
            chartSeries = new List<ChartSeries>();
            chartLabels = Array.Empty<string>();
            return;
        }

        // Filter data based on selected period
        var filteredTests = FilterTestsByPeriod(inrTests, chartPeriod);
        var orderedTests = filteredTests.OrderBy(t => t.TestDate).ToList();

        // Prepare chart labels (dates)
        chartLabels = orderedTests.Select(t => t.TestDate.ToString("MMM dd")).ToArray();

        // INR Values series
        var inrValues = orderedTests.Select(t => (double)t.INRValue).ToArray();

        // Target range series (min and max)
        var targetMin = Enumerable.Repeat(2.0, orderedTests.Count).ToArray();
        var targetMax = Enumerable.Repeat(3.0, orderedTests.Count).ToArray();

        chartSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "INR Value", Data = inrValues },
            new ChartSeries { Name = "Target Min (2.0)", Data = targetMin },
            new ChartSeries { Name = "Target Max (3.0)", Data = targetMax }
        };

        // Configure chart options
        chartOptions = new ChartOptions
        {
            YAxisTicks = 1,
            YAxisLines = true,
            XAxisLines = true
        };
    }

    private List<INRTest> FilterTestsByPeriod(List<INRTest> tests, string period)
    {
        var cutoffDate = period switch
        {
            "3m" => DateTime.Today.AddMonths(-3),
            "6m" => DateTime.Today.AddMonths(-6),
            "1y" => DateTime.Today.AddYears(-1),
            _ => DateTime.MinValue
        };

        return tests.Where(t => t.TestDate >= cutoffDate).ToList();
    }

    private void ChangeChartPeriod(string period)
    {
        chartPeriod = period;
        PrepareChartData();
        StateHasChanged();
    }

    private void ChangePage(int page)
    {
        if (page >= 1 && page <= totalPages)
        {
            currentPage = page;
            StateHasChanged();
        }
    }

    private void EditINRTest(string testId)
    {
        Navigation.NavigateTo($"/inr/edit/{testId}");
    }

    private void NavigateToAddINR()
    {
        Navigation.NavigateTo("/inr/add");
    }

    // Chart period methods
    private void ChangeChartPeriod3M() => ChangeChartPeriod("3m");
    private void ChangeChartPeriod6M() => ChangeChartPeriod("6m");
    private void ChangeChartPeriod1Y() => ChangeChartPeriod("1y");
    private void ChangeChartPeriodAll() => ChangeChartPeriod("all");

    private async Task DeleteINRTest(string testId)
    {
        // Show MudBlazor confirmation dialog
        var result = await DialogService.ShowMessageBox(
            "Delete INR Test",
            "Are you sure you want to delete this test result? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result == true)
        {
            try
            {
                // Call API to delete test with correct endpoint
                var response = await Http.DeleteAsync($"api/v1/inr/tests/{testId}");

                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("INR test deleted successfully", Severity.Success);
                    await LoadINRData();
                    PrepareChartData();
                    StateHasChanged();
                }
                else
                {
                    var errorMessage = await response.Content.ReadAsStringAsync();
                    Snackbar.Add($"Failed to delete test: {errorMessage}", Severity.Error);
                }
            }
            catch (HttpRequestException ex)
            {
                Snackbar.Add($"Network error deleting test: {ex.Message}", Severity.Error);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting test: {ex.Message}", Severity.Error);
            }
        }
    }

    private void ExportINRData()
    {
        if (inrTests?.Any() != true)
        {
            Snackbar.Add("No INR data to export", Severity.Warning);
            return;
        }

        try
        {
            // Generate CSV content
            var csv = new System.Text.StringBuilder();
            csv.AppendLine("Date,Time,INR Value,Target Min,Target Max,Status,Laboratory,Notes");

            foreach (var test in inrTests.OrderByDescending(t => t.TestDate))
            {
                var status = GetStatusText(test.INRValue);
                var notes = test.Notes?.Replace(",", ";").Replace("\n", " ") ?? "";

                csv.AppendLine($"{test.TestDate:yyyy-MM-dd}," +
                              $"{test.TestDate:HH:mm}," +
                              $"{test.INRValue:F1}," +
                              $"{test.TargetINRMin?.ToString("F1") ?? "N/A"}," +
                              $"{test.TargetINRMax?.ToString("F1") ?? "N/A"}," +
                              $"{status}," +
                              $"\"{test.Laboratory ?? "Not specified"}\"," +
                              $"\"{notes}\"");
            }

            // Create download using JavaScript interop would be needed here
            // For now, show success message and copy to clipboard hint
            Snackbar.Add($"CSV data prepared for {inrTests.Count} tests. Copy functionality requires JavaScript interop.",
                        Severity.Info,
                        config => { config.VisibleStateDuration = 5000; });
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting data: {ex.Message}", Severity.Error);
        }
    }

    // Helper methods for styling
    private string GetCurrentINRStatusClass()
    {
        if (currentINR == null) return "bg-secondary";
        return (currentINR >= 2.0m && currentINR <= 3.0m) ? "bg-success" :
               (currentINR < 2.0m) ? "bg-warning" : "bg-danger";
    }

    private string GetNextTestStatusClass()
    {
        return daysUntilNextTest <= 3 ? "bg-warning" :
               daysUntilNextTest <= 7 ? "bg-info" : "bg-primary";
    }

    private string GetRowClass(decimal inrValue)
    {
        if (inrValue < 2.0m) return "table-warning";
        if (inrValue > 3.0m) return "table-danger";
        return "";
    }

    private string GetValueClass(decimal inrValue)
    {
        if (inrValue < 2.0m) return "text-warning fw-bold";
        if (inrValue > 3.0m) return "text-danger fw-bold";
        return "text-success fw-bold";
    }

    private string GetStatusBadgeClass(decimal inrValue)
    {
        if (inrValue < 2.0m) return "bg-warning";
        if (inrValue > 3.0m) return "bg-danger";
        return "bg-success";
    }

    private Color GetStatusChipColor(decimal inrValue)
    {
        if (inrValue < 2.0m) return Color.Warning;
        if (inrValue > 3.0m) return Color.Error;
        return Color.Success;
    }

    private string GetStatusText(decimal inrValue)
    {
        if (inrValue < 2.0m) return "Below Range";
        if (inrValue > 3.0m) return "Above Range";
        return "In Range";
    }
}
