# Implementation Plan: Complex Medication Dosage Patterns

**Branch**: `005-medicine-schedule-to` | **Date**: 2025-11-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-medicine-schedule-to/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

**Primary Requirement**: Enable users to define complex medication dosage patterns (e.g., "4mg, 4mg, 3mg" repeating cycles) for blood thinner medications with variable dosing, supporting temporal tracking of pattern changes and variance detection between expected and actual dosages.

**Technical Approach**:
- Create new `MedicationDosagePattern` entity with JSON-stored pattern sequences and temporal validity (StartDate/EndDate)
- Enhance existing `Medication` entity with pattern navigation and calculation methods
- Add variance tracking fields to `MedicationLog` entity (ExpectedDosage, ActualDosage, PatternDayNumber)
- Use modulo arithmetic for O(1) pattern position calculation
- Implement MudBlazor components for flexible pattern entry (simple/pattern/advanced modes)
- RESTful API endpoints for pattern CRUD and schedule calculation
- Maintain backward compatibility (existing single-dosage medications continue to work)

**Architecture**: Model-first EF Core with temporal data pattern, pure .NET UI (MudBlazor), existing ASP.NET Core API + Blazor Web stack.

## Technical Context

**Language/Version**: C# 13 / .NET 10 (LTS)  
**Primary Dependencies**: 
- ASP.NET Core 10 (Web API)
- Entity Framework Core 10 (ORM, model-first)
- MudBlazor 7.x (UI components, Material Design)
- System.Text.Json (pattern JSON serialization)
- FluentValidation (validation rules)

**Storage**: 
- PostgreSQL (cloud/production) with JSONB columns
- SQLite (local development) with JSON columns
- EF Core migrations for schema management

**Testing**: 
- xUnit (unit + integration tests, target 90% coverage)
- bUnit (Blazor component tests)
- Playwright (E2E tests for critical flows)

**Target Platform**: 
- Backend: ASP.NET Core Web API (Linux/Windows)
- Frontend: Blazor Server/WebAssembly (browser)
- Mobile: .NET MAUI (iOS/Android - future phase)

**Project Type**: Web application (existing backend + frontend projects)

**Performance Goals**: 
- Pattern calculation: < 5ms (single date)
- Schedule generation (28 days): < 50ms
- Variance report (90 days): < 500ms
- API response time: < 200ms (local), < 2s (network)

**Constraints**: 
- 90% test coverage (constitutional requirement)
- No JavaScript interop (pure .NET UI)
- Model-first EF Core (no manual SQL)
- Medical data AES-256 encryption
- OWASP security compliance
- Backward compatible (no breaking changes to existing medications)

**Scale/Scope**: 
- Expected users: ~1,000 active users (MVP)
- Patterns per medication: 5-10 (historical tracking)
- Logs per user: ~365/year (daily dosing)
- Schedule calculations: 1-365 days per request

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **Principle I - Configuration Options Pattern**: No magic strings, all configuration in appsettings.json  
**Status**: PASS - Feature uses existing DB connection strings, no new configuration needed

✅ **Principle II - Code Quality & .NET Standards**: StyleCop, EditorConfig, Roslyn analyzers mandatory  
**Status**: PASS - All new code follows existing analyzers (.editorconfig, Directory.Build.props)

✅ **Principle III - Testing Discipline**: 90% minimum coverage (xUnit/BUnit/Playwright)  
**Status**: PASS - Feature includes:
- Unit tests for pattern calculation logic (MedicationDosagePattern.GetDosageForDay)
- Unit tests for variance tracking (MedicationLog.HasVariance)
- Integration tests for API endpoints (POST/GET patterns, GET schedule)
- bUnit tests for pattern entry UI components
- Estimated: 15 unit tests, 8 integration tests, 6 component tests = 29 tests total

✅ **Principle IV - UX Consistency & Pure .NET UI**: MudBlazor only, avoid JS interop  
**Status**: PASS - Pattern entry uses:
- MudToggleGroup for mode selection
- MudTextField for comma-separated input
- MudChipSet for visual pattern display
- MudDatePicker for date selection
- No JavaScript interop required

✅ **Principle V - Performance**: 200ms local, 2s network, <500ms queries  
**Status**: PASS - Performance analysis:
- Pattern calculation (modulo): <1ms (O(1) algorithm)
- Pattern lookup (indexed): <5ms (temporal index)
- Schedule generation (28 days): <50ms (in-memory loop)
- Variance report (90 days): <500ms (aggregation query with index)
- All within constitutional limits

✅ **Principle VI - Security & OWASP**: TLS 1.3, AES-256, ASP.NET Core Identity  
**Status**: PASS - Security considerations:
- Pattern data encrypted at rest (same as medication data)
- API endpoints require JWT authentication
- Input validation via FluentValidation (pattern length 1-365, dosage 0.1-1000mg)
- Warfarin-specific validation (max 20mg per safety guidelines)
- SQL injection prevented (EF Core parameterized queries)
- XSS prevention (Blazor automatic escaping)

✅ **Principle VII - Cloud Deployment**: Source-based Azure Container Apps  
**Status**: PASS - No deployment changes:
- Uses existing BloodThinnerTracker.Api project
- Uses existing BloodThinnerTracker.Web project
- No new containers or services required
- Database migrations applied via existing CD pipeline

✅ **Principle VIII - Feature Sizing**: 2-3 weeks max, ≤500 LOC PRs, feature flags  
**Status**: PASS - Feature scope:
- Estimated: 2 weeks (P1 stories = MVP)
- PR breakdown:
  - PR1: Data model + migrations (~300 LOC)
  - PR2: API endpoints (~350 LOC)
  - PR3: UI components (~400 LOC)
  - PR4: Tests (~450 LOC)
- Each PR ≤500 LOC (constitutional limit)
- P2/P3 stories can be feature-flagged for incremental release

## Project Structure

### Documentation (this feature)

```
specs/005-medicine-schedule-to/
├── spec.md              # Feature specification (COMPLETED by /speckit.specify)
├── plan.md              # This file (COMPLETED by /speckit.plan)
├── research.md          # Phase 0 output (COMPLETED)
├── data-model.md        # Phase 1 output (COMPLETED)
├── quickstart.md        # Phase 1 output (COMPLETED)
├── contracts/           # Phase 1 output (COMPLETED)
│   ├── medication-patterns-api.md
│   ├── medication-schedule-api.md
│   └── medication-log-api.md
├── checklists/          # Quality validation (COMPLETED)
│   └── requirements.md
└── tasks.md             # Phase 2 output (/speckit.tasks command - PENDING)
```

### Source Code (repository root)

```
blood_thinner_INR_tracker/
├── src/
│   ├── BloodThinnerTracker.Api/              # ASP.NET Core Web API
│   │   ├── Controllers/
│   │   │   ├── MedicationsController.cs       # MODIFY: Add pattern endpoints
│   │   │   └── MedicationLogsController.cs    # MODIFY: Add variance tracking
│   │   ├── Data/
│   │   │   └── ApplicationDbContext.cs        # MODIFY: Add MedicationDosagePattern DbSet
│   │   ├── Services/
│   │   │   ├── MedicationPatternService.cs    # NEW: Pattern CRUD logic
│   │   │   └── ScheduleCalculationService.cs  # NEW: Schedule generation
│   │   ├── Migrations/                        # NEW: EF Core migrations
│   │   │   ├── 20251103_AddMedicationDosagePatterns.cs
│   │   │   └── 20251103_AddVarianceTrackingToMedicationLog.cs
│   │   └── Validators/
│   │       └── DosagePatternValidator.cs      # NEW: FluentValidation rules
│   │
│   ├── BloodThinnerTracker.Web/              # Blazor Server/WebAssembly
│   │   ├── Components/
│   │   │   ├── Pages/
│   │   │   │   ├── Medications/
│   │   │   │   │   ├── Index.razor            # MODIFY: Add pattern indicator
│   │   │   │   │   ├── Details.razor          # MODIFY: Add pattern tab
│   │   │   │   │   └── PatternEntry.razor     # NEW: Pattern input component
│   │   │   │   └── Logs/
│   │   │   │       └── LogHistory.razor       # MODIFY: Add variance indicators
│   │   │   └── Shared/
│   │   │       ├── PatternDisplay.razor       # NEW: Pattern visualization
│   │   │       └── ScheduleCalendar.razor     # NEW: Future schedule view
│   │   └── Services/
│   │       ├── MedicationService.cs           # MODIFY: Add pattern API calls
│   │       └── MedicationLogService.cs        # MODIFY: Add variance API calls
│   │
│   └── BloodThinnerTracker.Shared/           # Shared models/DTOs
│       └── Models/
│           ├── Medication.cs                  # MODIFY: Add DosagePatterns navigation, GetExpectedDosageForDate()
│           ├── MedicationDosagePattern.cs     # NEW: Pattern entity
│           ├── MedicationLog.cs               # MODIFY: Add ExpectedDosage, ActualDosage, PatternDayNumber
│           └── DTOs/
│               ├── DosagePatternDto.cs        # NEW: Pattern response DTO
│               ├── ScheduleResponse.cs        # NEW: Schedule response DTO
│               └── VarianceReportDto.cs       # NEW: Variance report DTO
│
└── tests/
    ├── BloodThinnerTracker.Api.Tests/
    │   ├── Unit/
    │   │   ├── MedicationPatternTests.cs      # NEW: Pattern calculation tests
    │   │   ├── VarianceTrackingTests.cs       # NEW: Variance logic tests
    │   │   └── ScheduleCalculationTests.cs    # NEW: Schedule generation tests
    │   └── Integration/
    │       ├── PatternApiTests.cs             # NEW: Pattern endpoint tests
    │       └── ScheduleApiTests.cs            # NEW: Schedule endpoint tests
    │
    └── BloodThinnerTracker.Web.Tests/
        └── Components/
            ├── PatternEntryTests.cs           # NEW: bUnit tests for pattern entry
            └── ScheduleCalendarTests.cs       # NEW: bUnit tests for schedule view
```

**Structure Decision**: Web application structure (Option 2) - Feature enhances existing API and Web projects. No new projects required. All changes fit within existing BloodThinnerTracker.{Api, Web, Shared} structure following David Fowler's repository layout conventions.

**Key File Changes**:
- **3 New Entities**: MedicationDosagePattern, DTOs for pattern/schedule/variance
- **3 Modified Entities**: Medication, MedicationLog, ApplicationDbContext
- **2 New Services**: MedicationPatternService, ScheduleCalculationService
- **2 Modified Controllers**: MedicationsController, MedicationLogsController
- **5 New UI Components**: PatternEntry, PatternDisplay, ScheduleCalendar (Blazor)
- **2 Modified UI Pages**: Medications/Details, Logs/LogHistory
- **2 EF Core Migrations**: AddMedicationDosagePatterns, AddVarianceTracking
- **8+ Test Files**: Unit (pattern calc, variance), Integration (APIs), bUnit (UI)

## Complexity Tracking

*No violations - constitutional compliance maintained*

**Zero Violations**: This feature adheres to all 8 constitutional principles:
- Uses existing 3 projects (Api, Web, Shared) - no 4th project needed
- No repository pattern - EF Core DbContext used directly per convention
- Model-first EF Core - no custom data access layer
- Pure .NET UI - MudBlazor components only, no JS interop
- Feature sized 2-3 weeks with ≤500 LOC PRs
- 90% test coverage plan included
- No new configuration required
- Standard Azure Container Apps deployment (no changes)

**Complexity Justification**: N/A - feature maintains simplicity

---

## Phase 0 Output: Research

**File**: `research.md` (COMPLETED)

**Research Topics Addressed**:
1. ✅ **R1**: Pattern storage strategy (JSON columns with EF Core 9+)
2. ✅ **R2**: Pattern position calculation (modulo arithmetic for O(1) performance)
3. ✅ **R3**: MudBlazor pattern entry UI (MudToggleGroup + MudChipSet)
4. ✅ **R4**: Historical pattern querying (temporal data with StartDate/EndDate)
5. ✅ **R5**: MedicationLog variance tracking (ExpectedDosage vs. ActualDosage)
6. ✅ **R6**: Migration strategy for existing medications (single-value = length 1 pattern)
7. ✅ **R7**: Performance optimization (on-demand calculation, client-side caching)
8. ✅ **R8**: EF Core migration sequence (4 migrations with rollback safety)
9. ✅ **R9**: Validation rules (multi-level: client/server/database)
10. ✅ **R10**: API contract design (RESTful sub-resources, OpenAPI schema)

**Key Decisions**:
- **Storage**: EF Core 9 JSON column mapping (`List<decimal>` property, JSONB/JSON column type)
- **Calculation**: Modulo arithmetic `(days_since_start % pattern_length) + 1` for O(1) performance
- **UI**: Three input modes (Simple/Pattern/Advanced) with MudBlazor components
- **History**: Temporal querying with `WHERE StartDate <= @date AND (EndDate IS NULL OR EndDate >= @date)`
- **Variance**: Auto-populate `ExpectedDosage` on log creation, compute `HasVariance` flag
- **Migration**: Treat existing medications as length-1 patterns (zero data loss)

**Status**: Research complete, all technical unknowns resolved, zero "NEEDS CLARIFICATION" markers.

---

## Phase 1 Output: Design & Contracts

### A. Data Model

**File**: `data-model.md` (COMPLETED)

**Entities Designed**:

1. **MedicationDosagePattern** (NEW):
   - `Id` (int, PK)
   - `MedicationId` (int, FK)
   - `PatternSequence` (List<decimal>, JSON column)
   - `StartDate` (DateTime, required)
   - `EndDate` (DateTime?, nullable = active)
   - `Notes` (string?, optional)
   - Methods: `GetDosageForDay(int)`, `GetDosageForDate(DateTime)`
   - Computed: `PatternLength`, `IsActive`, `AverageDosage`

2. **Medication** (ENHANCED):
   - Added: `ICollection<MedicationDosagePattern> DosagePatterns` (navigation)
   - Added: `MedicationDosagePattern? ActivePattern` (computed)
   - Added: `bool HasPatternSchedule` (computed)
   - Added: `GetExpectedDosageForDate(DateTime)` method
   - Added: `GetPatternForDate(DateTime)` method
   - Added: `GetFutureSchedule(DateTime, int)` method

3. **MedicationLog** (ENHANCED):
   - Added: `decimal ActualDosage` (renamed from Dosage)
   - Added: `decimal? ExpectedDosage` (from pattern calculation)
   - Added: `int? PatternDayNumber` (position in cycle)
   - Added: `int? DosagePatternId` (FK to active pattern)
   - Added: `bool HasVariance` (computed)
   - Added: `decimal? VarianceAmount` (computed)
   - Added: `decimal? VariancePercentage` (computed)
   - Added: `SetExpectedDosageFromMedication(Medication)` helper

**Database Schema**:
- **New Table**: `MedicationDosagePatterns` (8 columns + audit fields)
- **Modified Table**: `MedicationLogs` (3 new nullable columns)
- **New Indexes**: 
  - `IX_MedicationDosagePattern_Temporal (MedicationId, StartDate, EndDate)`
  - `IX_MedicationDosagePattern_Active (MedicationId, EndDate)` with filter `EndDate IS NULL`
  - `IX_MedicationLogs_DosagePatternId`

**Temporal Query Pattern**: 
```sql
SELECT * FROM MedicationDosagePatterns
WHERE MedicationId = @medicationId
  AND StartDate <= @targetDate
  AND (EndDate IS NULL OR EndDate >= @targetDate)
ORDER BY StartDate DESC
LIMIT 1;
```

### B. API Contracts

**Files**: `contracts/` directory (COMPLETED)

**1. medication-patterns-api.md**:
- **POST** `/api/medications/{id}/patterns` - Create new pattern
- **GET** `/api/medications/{id}/patterns` - List pattern history (pagination)
- **GET** `/api/medications/{id}/patterns/active` - Get current active pattern
- **PUT** `/api/medications/{id}/patterns/{patternId}` - Update pattern
- **DELETE** `/api/medications/{id}/patterns/{patternId}` - Soft delete (close pattern)
- DTOs: `CreateDosagePatternRequest`, `UpdateDosagePatternRequest`, `DosagePatternDto`
- Validation: Pattern length 1-365, each dosage 0.1-1000mg, Warfarin ≤20mg

**2. medication-schedule-api.md**:
- **GET** `/api/medications/{id}/schedule?startDate=&days=14` - Future dosage schedule
- **GET** `/api/medications/{id}/schedule/date?date=` - Single date dosage
- **GET** `/api/medications/{id}/schedule/detailed?days=60` - Multi-pattern schedule
- DTOs: `ScheduleResponse`, `ScheduleEntry`, `ScheduleSummary`, `PatternSummaryDto`
- Performance: 1-14 days <5ms, 15-28 days <10ms, 29-90 days <50ms, 91-365 days <200ms
- Caching: `Cache-Control: private, max-age=3600`, ETag includes pattern ID

**3. medication-log-api.md**:
- **POST** `/api/medication-logs` - Enhanced with auto-calculated ExpectedDosage
- **GET** `/api/medication-logs?includeVariance=true&varianceThreshold=0.5` - Filter variance
- **GET** `/api/medication-logs/variance-report` - NEW: Variance analytics (90-day report)
- DTOs: `MedicationLogDto` (enhanced), `VarianceReportDto`, `VarianceSummary`, `VarianceBreakdown`
- Backward compatibility: Existing `dosage` field aliased to `actualDosage`

**Authorization**: All endpoints require JWT bearer token, user ownership validation

**Rate Limiting**: 
- Pattern CRUD: 100 req/min (standard), 1000 req/min (premium)
- Schedule read: 200 req/min (standard), 2000 req/min (premium)

### C. Developer Quickstart

**File**: `quickstart.md` (COMPLETED)

**Contents**:
- Prerequisites checklist (.NET 10 SDK, EF Core CLI, PostgreSQL/SQLite, Git)
- Quick setup (5 min): Clone, restore, build
- Database setup (5 min): Create migration, apply migration, verify
- Testing setup (3 min): Run unit/integration/bUnit tests
- Running application (2 min): Aspire/API-only/Web-only options
- Feature verification: 4 test scenarios (create pattern, get schedule, log dose, view UI)
- Troubleshooting: Common issues (migration exists, DB connection, JWT expired, validation errors)
- Development workflow: Branch, change, migrate, test, commit, push
- Useful commands: Database, testing, build commands
- Code examples: Service method, controller action, Blazor component (Razor)

**Estimated Setup Time**: 15 minutes (first-time developer)

### D. Agent Context Update

**File**: `.github/copilot-instructions.md` (UPDATED)

**Additions**:
- **Pattern Management** section under Key Entities
- **Temporal Pattern Tracking** explanation (StartDate/EndDate, JSON sequences)
- **Pattern Calculation Pattern** code example (GetExpectedDosageForDate method)
- **Variance Tracking** explanation (ExpectedDosage, ActualDosage, HasVariance)
- **MudBlazor Pattern Entry Components** UI modes (Simple/Pattern/Advanced)
- **API Patterns** endpoint list (POST/GET patterns, GET schedule, GET variance report)

**Purpose**: Provides future GitHub Copilot context for pattern-related code generation

---

## Summary

**Planning Phase Status**: ✅ **COMPLETE**

**Deliverables**:
- ✅ Research document (10 technical decisions documented)
- ✅ Data model specification (3 entities: 1 new, 2 enhanced)
- ✅ API contracts (3 contract files, 10+ endpoints documented)
- ✅ Developer quickstart (15-minute setup guide)
- ✅ Agent context update (copilot-instructions.md enhanced)
- ✅ Implementation plan (this file - all sections filled)

**Constitution Check**: ✅ **PASS** - All 8 principles validated, zero violations

**Technical Context**: ✅ **COMPLETE** - All "NEEDS CLARIFICATION" resolved

**Next Command**: `/speckit.tasks` - Generate task breakdown for implementation

**Estimated Implementation**:
- **Time**: 2 weeks (P1 stories = MVP)
- **PRs**: 4 PRs (data model, API, UI, tests) × ≤500 LOC each
- **Tests**: 29+ tests (15 unit, 8 integration, 6 bUnit) targeting 90% coverage
- **Migrations**: 2 EF Core migrations (pattern table, variance columns)

**Ready for Development**: ✅ YES
